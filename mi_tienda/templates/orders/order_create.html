{% extends 'base.html' %}

{% block title %}Finalizar Compra - Mi Tienda{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">Finalizar Compra</h1>
    
    <!-- Modal de confirmación (oculto inicialmente) -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-green-600 mb-4">¡Felicidades por tu compra!</h2>
            <p class="mb-6">Tu pedido ha sido procesado exitosamente. Recibirás un correo de confirmación shortly.</p>
            <button id="closeModal" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">
                Aceptar
            </button>
        </div>
    </div>
    
    <div class="grid md:grid-cols-2 gap-8">
        <!-- Resumen del pedido -->
        <div>
            <h2 class="text-xl font-semibold mb-4">Resumen de tu pedido</h2>
            <div class="bg-white rounded-lg shadow-md p-6">
                {% for item in cart %}
                <div class="flex justify-between items-center py-3 border-b border-gray-200">
                    <div>
                        <div class="font-medium">{{ item.product.name }}</div>
                        <div class="text-sm text-gray-600">{{ item.quantity }} x ${{ item.price|floatformat:2 }}</div>
                    </div>
                    <div class="font-semibold">${{ item.total_price|floatformat:2 }}</div>
                </div>
                {% endfor %}
                
                <div class="mt-4 space-y-2">
                    <div class="flex justify-between">
                        <span>Subtotal:</span>
                        <span>${{ subtotal|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>IVA:</span>
                        <span>${{ total_iva|floatformat:2 }}</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold border-t border-gray-200 pt-2 mt-2">
                        <span>Total:</span>
                        <span class="text-blue-600">${{ total|floatformat:2 }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Gestión de direcciones guardadas -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-4">Direcciones guardadas</h2>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div id="savedAddresses" class="space-y-3 mb-4 max-h-40 overflow-y-auto">
                        <!-- Las direcciones guardadas se cargarán aquí -->
                    </div>
                    <button id="newAddressBtn" class="text-blue-600 text-sm hover:underline">
                        + Agregar nueva dirección
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Formulario de envío -->
        <div>
            <h2 class="text-xl font-semibold mb-4">Información de envío</h2>
            <div class="bg-white rounded-lg shadow-md p-6">
                <form id="shippingForm" method="post">
                    {% csrf_token %}
                    
                    <input type="hidden" id="addressId" name="address_id" value="">
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700">Nombres</label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.first_name.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700">Apellidos</label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.last_name.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700">Correo electrónico</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.email.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.address.id_for_label }}" class="block text-sm font-medium text-gray-700">Dirección de envío</label>
                        {{ form.address }}
                        {% if form.address.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.address.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="{{ form.postal_code.id_for_label }}" class="block text-sm font-medium text-gray-700">Código postal</label>
                            {{ form.postal_code }}
                            {% if form.postal_code.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.postal_code.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div>
                            <label for="{{ form.city.id_for_label }}" class="block text-sm font-medium text-gray-700">Ciudad</label>
                            {{ form.city }}
                            {% if form.city.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.city.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700">Teléfono</label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                        <p class="text-red-500 text-xs mt-1">{{ form.phone.errors.0 }}</p>
                            {% endif %}
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <button type="button" id="saveAddressBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-medium hover:bg-gray-300">
                            Guardar dirección
                        </button>
                        <button type="button" id="resetFormBtn" class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-medium hover:bg-gray-300">
                            Limpiar
                        </button>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700">
                        Confirmar Pedido
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Almacenamiento local para las direcciones
        let addresses = JSON.parse(localStorage.getItem('shippingAddresses')) || [];
        const savedAddressesContainer = document.getElementById('savedAddresses');
        const shippingForm = document.getElementById('shippingForm');
        const addressIdField = document.getElementById('addressId');
        const saveAddressBtn = document.getElementById('saveAddressBtn');
        const resetFormBtn = document.getElementById('resetFormBtn');
        const newAddressBtn = document.getElementById('newAddressBtn');
        const confirmationModal = document.getElementById('confirmationModal');
        const closeModalBtn = document.getElementById('closeModal');
        
        // Función para renderizar direcciones guardadas
        function renderSavedAddresses() {
            savedAddressesContainer.innerHTML = '';
            
            if (addresses.length === 0) {
                savedAddressesContainer.innerHTML = '<p class="text-gray-500 text-sm">No hay direcciones guardadas</p>';
                return;
            }
            
            addresses.forEach((address, index) => {
                const addressElement = document.createElement('div');
                addressElement.className = 'border rounded p-2 cursor-pointer hover:bg-gray-50';
                addressElement.innerHTML = `
                    <div class="font-medium">${address.first_name} ${address.last_name}</div>
                    <div class="text-sm text-gray-600">${address.address}, ${address.city}</div>
                    <div class="mt-1 flex gap-2">
                        <button class="use-address text-blue-600 text-xs hover:underline" data-index="${index}">Usar</button>
                        <button class="delete-address text-red-600 text-xs hover:underline" data-index="${index}">Eliminar</button>
                    </div>
                `;
                savedAddressesContainer.appendChild(addressElement);
            });
            
            // Agregar event listeners a los botones
            document.querySelectorAll('.use-address').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    fillFormWithAddress(addresses[index]);
                    addressIdField.value = index; // Establecer el ID de la dirección seleccionada
                });
            });
            
            document.querySelectorAll('.delete-address').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    addresses.splice(index, 1);
                    localStorage.setItem('shippingAddresses', JSON.stringify(addresses));
                    renderSavedAddresses();
                    resetForm();
                });
            });
        }
        
        // Función para llenar el formulario con una dirección
        function fillFormWithAddress(address) {
            document.getElementById('id_first_name').value = address.first_name || '';
            document.getElementById('id_last_name').value = address.last_name || '';
            document.getElementById('id_email').value = address.email || '';
            document.getElementById('id_address').value = address.address || '';
            document.getElementById('id_postal_code').value = address.postal_code || '';
            document.getElementById('id_city').value = address.city || '';
            document.getElementById('id_phone').value = address.phone || '';
        }
        
        // Función para resetear el formulario
        function resetForm() {
            shippingForm.reset();
            addressIdField.value = '';
        }
        
        // Guardar dirección en el almacenamiento local
        saveAddressBtn.addEventListener('click', function() {
            const formData = new FormData(shippingForm);
            const address = {
                first_name: document.getElementById('id_first_name').value,
                last_name: document.getElementById('id_last_name').value,
                email: document.getElementById('id_email').value,
                address: document.getElementById('id_address').value,
                postal_code: document.getElementById('id_postal_code').value,
                city: document.getElementById('id_city').value,
                phone: document.getElementById('id_phone').value
            };
            
            // Si hay un ID, actualizar la dirección existente
            if (addressIdField.value !== '') {
                addresses[parseInt(addressIdField.value)] = address;
            } else {
                // Si no hay ID, agregar nueva dirección
                addresses.push(address);
            }
            
            localStorage.setItem('shippingAddresses', JSON.stringify(addresses));
            renderSavedAddresses();
            alert('Dirección guardada correctamente');
        });
        
        // Botón para nueva dirección
        newAddressBtn.addEventListener('click', function() {
            resetForm();
        });
        
        // Botón para resetear formulario
        resetFormBtn.addEventListener('click', function() {
            resetForm();
        });
        
        // Manejar envío del formulario
        shippingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Aquí normalmente se enviarían los datos al servidor
            // Pero para este ejemplo, solo mostraremos el modal
            
            // Mostrar modal de confirmación
            confirmationModal.classList.remove('hidden');
        });
        
        // Cerrar modal
        closeModalBtn.addEventListener('click', function() {
            confirmationModal.classList.add('hidden');
        });
        
        // Cerrar modal al hacer clic fuera del contenido
        confirmationModal.addEventListener('click', function(e) {
            if (e.target === confirmationModal) {
                confirmationModal.classList.add('hidden');
            }
        });
        
        // Inicializar direcciones guardadas
        renderSavedAddresses();
    });
</script>

<style>
    #confirmationModal {
        transition: opacity 0.3s ease;
    }
    
    #savedAddresses::-webkit-scrollbar {
        width: 6px;
    }
    
    #savedAddresses::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    #savedAddresses::-webkit-scrollbar-thumb {
        background: #c5c5c5;
        border-radius: 10px;
    }
</style>
{% endblock %}